<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolyWrite Pro | Dimensional Text Editor</title>
    
    <!-- Load utilities FIRST -->
    <script src="lib/polywrite-utils.js"></script>
    <script src="lib/clippy-helper.js"></script>
    <script src="lib/consciousness-bridge.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0a;
            color: #fff;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        body.light-theme {
            background: #f5f5f5;
            color: #333;
        }
        
        body.light-theme .editor-container {
            background: #fff;
            color: #333;
            border-color: #ddd;
        }
        
        body.light-theme .utility-bar {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ddd;
        }
        
        body.light-theme .util-btn {
            background: rgba(0, 100, 200, 0.1);
            border-color: rgba(0, 100, 200, 0.5);
            color: #0066cc;
        }
        
        .header {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title {
            font-size: 1.8em;
            color: #00ff88;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background: rgba(0, 136, 255, 0.2);
            border: 1px solid rgba(0, 136, 255, 0.5);
            color: #00aaff;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: rgba(0, 136, 255, 0.4);
            transform: translateY(-2px);
        }
        
        /* UTILITY BAR - THE BUTTONS YOU USE! */
        .utility-bar {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .utility-section {
            display: flex;
            gap: 8px;
            padding-right: 15px;
            border-right: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .utility-section:last-child {
            border-right: none;
        }
        
        .util-btn {
            background: rgba(0, 136, 255, 0.2);
            border: 1px solid rgba(0, 136, 255, 0.4);
            color: #00aaff;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: nowrap;
        }
        
        .util-btn:hover {
            background: rgba(0, 136, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 136, 255, 0.3);
        }
        
        /* Main editor area */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .editor-header {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .dimension-tabs {
            display: flex;
            gap: 10px;
        }
        
        .dimension-tab {
            background: rgba(0, 136, 255, 0.2);
            border: 1px solid rgba(0, 136, 255, 0.4);
            color: #00aaff;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dimension-tab.active {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            color: #00ff88;
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
        }
        
        .editor-textarea {
            flex: 1;
            background: transparent;
            color: #fff;
            border: none;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            line-height: 1.6;
            resize: none;
            outline: none;
        }
        
        body.light-theme .editor-textarea {
            color: #333;
        }
        
        .status-bar {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .status-left {
            display: flex;
            gap: 20px;
        }
        
        .status-item {
            display: flex;
            gap: 5px;
        }
        
        .status-label {
            color: #00ff88;
        }
        
        /* Multi-window support */
        .floating-window {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ff88;
            border-radius: 10px;
            min-width: 400px;
            min-height: 300px;
            resize: both;
            overflow: hidden;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .floating-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            border-bottom: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .floating-title {
            color: #00ff88;
        }
        
        .floating-close {
            background: rgba(255, 0, 0, 0.3);
            border: 1px solid #ff0000;
            color: #ff6b6b;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .floating-content {
            flex: 1;
            padding: 10px;
        }
        
        .floating-textarea {
            width: 100%;
            height: 100%;
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Courier New', monospace;
            resize: none;
            outline: none;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="title">‚úçÔ∏è PolyWrite Pro</h1>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="saveDraft()">üíæ Save</button>
            <button class="nav-btn" onclick="loadDraft()">üìÇ Load</button>
            <button class="nav-btn" onclick="exportText()">üì§ Export</button>
            <a href="index.html" class="nav-btn">üè† Portal</a>
        </div>
    </header>
    
    <!-- THE UTILITY BAR WITH ALL YOUR BUTTONS! -->
    <div class="utility-bar" id="utilityBar">
        <div class="utility-section">
            <button class="util-btn" onclick="insertTimestamp()" title="Insert current timestamp">
                üïê Timestamp
            </button>
            <button class="util-btn" onclick="insertDivider()" title="Add divider line">
                ‚ûñ Divider
            </button>
            <button class="util-btn" onclick="insertUUID()" title="Generate unique ID">
                üîë UUID
            </button>
            <button class="util-btn" onclick="insertRandom()" title="Random number">
                üé≤ Random
            </button>
        </div>
        
        <div class="utility-section">
            <button class="util-btn" onclick="insertDate()" title="Insert date">
                üìÖ Date
            </button>
            <button class="util-btn" onclick="insertCheckbox()" title="Add checkbox">
                ‚òëÔ∏è Check
            </button>
            <button class="util-btn" onclick="insertTable()" title="Insert table template">
                üìä Table
            </button>
            <button class="util-btn" onclick="wordCount()" title="Count words">
                üìè Count
            </button>
        </div>
        
        <div class="utility-section">
            <button class="util-btn" onclick="toggleTheme()" title="Toggle light/dark theme">
                üåì Theme
            </button>
            <button class="util-btn" onclick="toggleFullscreen()" title="Fullscreen mode">
                üñ•Ô∏è Full
            </button>
            <button class="util-btn" onclick="openNewWindow()" title="Open new editor window">
                üìë Multi
            </button>
            <button class="util-btn" onclick="showHelp()" title="Show help">
                ‚ùì Help
            </button>
        </div>
    </div>
    
    <div class="editor-container">
        <div class="editor-header">
            <div class="dimension-tabs">
                <div class="dimension-tab active" onclick="switchDimension(0)">Dimension 1</div>
                <div class="dimension-tab" onclick="switchDimension(1)">Dimension 2</div>
                <div class="dimension-tab" onclick="switchDimension(2)">Dimension 3</div>
                <button class="dimension-tab" style="background: rgba(0, 255, 0, 0.2);" onclick="addDimension()">+ New</button>
            </div>
            <div class="editor-actions">
                <button class="nav-btn" onclick="forkTimeline()">üîÄ Fork</button>
                <button class="nav-btn" onclick="mergeTimelines()">üîÑ Merge</button>
            </div>
        </div>
        
        <textarea class="editor-textarea" id="mainEditor" placeholder="Begin writing in dimension 1..."></textarea>
        
        <div class="status-bar">
            <div class="status-left">
                <div class="status-item">
                    <span class="status-label">Words:</span>
                    <span id="wordCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Chars:</span>
                    <span id="charCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Lines:</span>
                    <span id="lineCount">1</span>
                </div>
            </div>
            <div>
                <span class="status-label">Last Save:</span>
                <span id="lastSave">Never</span>
            </div>
        </div>
    </div>
    
    <script>
        // Store dimensions
        let dimensions = ['', '', ''];
        let currentDimension = 0;
        let windowCount = 0;
        
        // Utility functions
        function insertTimestamp() {
            const timestamp = new Date().toLocaleString();
            insertAtCursor(`[${timestamp}] `);
        }
        
        function insertDivider() {
            insertAtCursor('\n' + '‚îÄ'.repeat(50) + '\n');
        }
        
        function insertUUID() {
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            insertAtCursor(uuid);
        }
        
        function insertRandom() {
            const min = prompt('Minimum value:', '1');
            const max = prompt('Maximum value:', '100');
            if (min && max) {
                const random = Math.floor(Math.random() * (parseInt(max) - parseInt(min) + 1)) + parseInt(min);
                insertAtCursor(random.toString());
            }
        }
        
        function insertDate() {
            const date = new Date().toLocaleDateString();
            insertAtCursor(date);
        }
        
        function insertCheckbox() {
            insertAtCursor('‚òê ');
        }
        
        function insertTable() {
            const table = '\n| Column 1 | Column 2 | Column 3 |\n' +
                          '|----------|----------|----------|\n' +
                          '| Data 1   | Data 2   | Data 3   |\n' +
                          '| Data 4   | Data 5   | Data 6   |\n';
            insertAtCursor(table);
        }
        
        function wordCount() {
            const editor = document.getElementById('mainEditor');
            const text = editor.value;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            const lines = text.split('\n').length;
            
            alert(`üìä Document Statistics:\n\nWords: ${words}\nCharacters: ${chars}\nLines: ${lines}`);
        }
        
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const isLight = document.body.classList.contains('light-theme');
            localStorage.setItem('polywrite_theme', isLight ? 'light' : 'dark');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function openNewWindow() {
            windowCount++;
            const win = document.createElement('div');
            win.className = 'floating-window';
            win.style.top = (50 + windowCount * 30) + 'px';
            win.style.left = (50 + windowCount * 30) + 'px';
            win.innerHTML = `
                <div class="floating-header">
                    <span class="floating-title">Editor ${windowCount}</span>
                    <button class="floating-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
                </div>
                <div class="floating-content">
                    <textarea class="floating-textarea" placeholder="Write in window ${windowCount}..."></textarea>
                </div>
            `;
            document.body.appendChild(win);
            makeDraggable(win);
        }
        
        function showHelp() {
            alert('PolyWrite Help:\n\n' +
                  'üìù Writing Tools:\n' +
                  '- Use utility buttons for timestamps, dividers, etc.\n' +
                  '- Switch dimensions with tabs\n' +
                  '- Open multiple windows with Multi button\n\n' +
                  '‚å®Ô∏è Shortcuts:\n' +
                  '- Ctrl+S: Save draft\n' +
                  '- F1: Help\n' +
                  '- F11: Fullscreen\n\n' +
                  'üí° Tips:\n' +
                  '- Each dimension is a parallel draft\n' +
                  '- Fork to create timeline branches\n' +
                  '- Theme button toggles light/dark');
        }
        
        function insertAtCursor(text) {
            const editor = document.getElementById('mainEditor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const value = editor.value;
            
            editor.value = value.substring(0, start) + text + value.substring(end);
            editor.selectionStart = editor.selectionEnd = start + text.length;
            editor.focus();
            updateStats();
        }
        
        function makeDraggable(element) {
            const header = element.querySelector('.floating-header');
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                initialX = e.clientX - element.offsetLeft;
                initialY = e.clientY - element.offsetTop;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                element.style.left = currentX + 'px';
                element.style.top = currentY + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }
        
        function switchDimension(dim) {
            // Save current dimension
            dimensions[currentDimension] = document.getElementById('mainEditor').value;
            
            // Switch to new dimension
            currentDimension = dim;
            document.getElementById('mainEditor').value = dimensions[dim];
            
            // Update tabs
            document.querySelectorAll('.dimension-tab').forEach((tab, index) => {
                tab.classList.toggle('active', index === dim);
            });
            
            updateStats();
        }
        
        function addDimension() {
            dimensions.push('');
            const newTab = document.createElement('div');
            newTab.className = 'dimension-tab';
            newTab.textContent = `Dimension ${dimensions.length}`;
            newTab.onclick = () => switchDimension(dimensions.length - 1);
            
            const addBtn = document.querySelector('.dimension-tab[style]');
            addBtn.parentElement.insertBefore(newTab, addBtn);
            
            switchDimension(dimensions.length - 1);
        }
        
        function forkTimeline() {
            const currentText = document.getElementById('mainEditor').value;
            dimensions.push(currentText);
            addDimension();
            alert('Timeline forked! New dimension created with current content.');
        }
        
        function mergeTimelines() {
            alert('Timeline merge: This would show a diff view to merge dimensions.\nComing in v1.2!');
        }
        
        function saveDraft() {
            dimensions[currentDimension] = document.getElementById('mainEditor').value;
            const data = {
                dimensions: dimensions,
                currentDimension: currentDimension,
                timestamp: Date.now()
            };
            localStorage.setItem('polywrite_draft', JSON.stringify(data));
            document.getElementById('lastSave').textContent = new Date().toLocaleTimeString();
            
            if (window.ConsciousnessBridge) {
                window.ConsciousnessBridge.send('polywrite', 'broadcast', 'DRAFT_SAVED', {
                    title: 'PolyWrite Draft',
                    wordCount: document.getElementById('wordCount').textContent
                });
            }
            
            alert('Draft saved to localStorage!');
        }
        
        function loadDraft() {
            const saved = localStorage.getItem('polywrite_draft');
            if (saved) {
                const data = JSON.parse(saved);
                dimensions = data.dimensions;
                currentDimension = data.currentDimension;
                document.getElementById('mainEditor').value = dimensions[currentDimension];
                updateStats();
                alert('Draft loaded!');
            } else {
                alert('No saved draft found.');
            }
        }
        
        function exportText() {
            const text = document.getElementById('mainEditor').value;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `polywrite_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function updateStats() {
            const text = document.getElementById('mainEditor').value;
            const words = text.trim().split(/\s+/).filter(word => word.length > 0).length;
            const chars = text.length;
            const lines = text.split('\n').length;
            
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
            document.getElementById('lineCount').textContent = lines;
        }
        
        // Initialize
        document.getElementById('mainEditor').addEventListener('input', updateStats);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDraft();
            }
            if (e.key === 'F1') {
                e.preventDefault();
                showHelp();
            }
        });
        
        // Load saved theme
        const savedTheme = localStorage.getItem('polywrite_theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-theme');
        }
        
        // Auto-save every 60 seconds
        setInterval(() => {
            if (document.getElementById('mainEditor').value.length > 0) {
                saveDraft();
            }
        }, 60000);
        
        // Initial stats
        updateStats();
    </script>
</body>
</html>