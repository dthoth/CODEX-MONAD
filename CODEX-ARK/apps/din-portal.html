<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIN Portal | CODEX-ARK</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg: #0a0a0f;
            --surface: #111118;
            --border: #252530;
            --text: #d0d0d0;
            --dim: #707080;
            --accent: #ff6611;
        }
        body {
            font-family: ui-monospace, Consolas, 'Courier New', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .title {
            font-size: 1rem;
            color: var(--accent);
            text-decoration: none;
        }
        .title:hover { text-decoration: underline; }
        .header-right {
            display: flex;
            gap: 0.5rem;
        }
        button {
            font-family: inherit;
            font-size: 0.8rem;
            padding: 0.4rem 0.75rem;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            cursor: pointer;
        }
        button:hover { border-color: var(--accent); }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        .input-section {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 1rem;
        }
        .input-section h2 {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
            font-weight: normal;
            letter-spacing: 0.1em;
        }
        textarea {
            width: 100%;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.75rem;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.5;
            resize: vertical;
            min-height: 80px;
        }
        textarea:focus { outline: none; border-color: var(--accent); }
        input[type="text"] {
            width: 100%;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.5rem 0.75rem;
            font-family: inherit;
            font-size: 0.85rem;
        }
        input[type="text"]:focus { outline: none; border-color: var(--accent); }
        .input-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .input-row input { flex: 1; }
        .filter-section {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-section label {
            font-size: 0.8rem;
            color: var(--dim);
        }
        .filter-section input {
            flex: 1;
            min-width: 150px;
        }
        .tag-cloud {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        .tag {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            background: var(--border);
            cursor: pointer;
            border: 1px solid transparent;
        }
        .tag:hover { border-color: var(--accent); }
        .tag.active { background: var(--accent); color: var(--bg); }
        .entries-section {
            flex: 1;
        }
        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            color: var(--dim);
        }
        .entries {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .entry {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 0.75rem;
        }
        .entry-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--dim);
            margin-bottom: 0.5rem;
        }
        .entry-tags {
            display: flex;
            gap: 0.3rem;
        }
        .entry-tag {
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            background: var(--border);
        }
        .entry-text {
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .entry-actions {
            margin-top: 0.5rem;
            text-align: right;
        }
        .entry-actions button {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            opacity: 0.7;
        }
        .entry-actions button:hover { opacity: 1; }
        .empty {
            text-align: center;
            color: var(--dim);
            padding: 2rem;
            font-size: 0.9rem;
        }
        .stats {
            font-size: 0.75rem;
            color: var(--dim);
            padding: 0.5rem 0;
            text-align: center;
            border-top: 1px solid var(--border);
        }
    </style>
</head>
<body>

<header>
    <a href="../index.html" class="title">◂ DIN Portal</a>
    <div class="header-right">
        <button onclick="exportData()">Export JSON</button>
        <button onclick="importData()">Import</button>
    </div>
</header>

<div class="main">
    <div class="input-section">
        <h2>+ NEW OBSERVATION</h2>
        <textarea id="obsText" placeholder="What did you notice?"></textarea>
        <div class="input-row">
            <input type="text" id="obsTags" placeholder="Tags (comma separated)">
            <button onclick="addEntry()">Add</button>
        </div>
    </div>

    <div class="filter-section">
        <label>Filter:</label>
        <input type="text" id="filterText" placeholder="Search text...">
        <div class="tag-cloud" id="tagCloud"></div>
    </div>

    <div class="entries-section">
        <div class="entries-header">
            <span id="entryCount">0 observations</span>
            <span id="activeFilter"></span>
        </div>
        <div class="entries" id="entriesList"></div>
    </div>
</div>

<div class="stats" id="stats"></div>

<input type="file" id="importInput" accept=".json" style="display:none">

<script>
(function() {
    var STORAGE_KEY = 'din_observations';
    var entries = [];
    var activeTag = null;

    var obsText = document.getElementById('obsText');
    var obsTags = document.getElementById('obsTags');
    var filterText = document.getElementById('filterText');
    var tagCloud = document.getElementById('tagCloud');
    var entriesList = document.getElementById('entriesList');
    var entryCount = document.getElementById('entryCount');
    var activeFilter = document.getElementById('activeFilter');
    var stats = document.getElementById('stats');
    var importInput = document.getElementById('importInput');

    function load() {
        try {
            var saved = localStorage.getItem(STORAGE_KEY);
            if (saved) entries = JSON.parse(saved);
        } catch(e) {}
    }

    function save() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
        } catch(e) {}
    }

    function getAllTags() {
        var tags = {};
        entries.forEach(function(e) {
            (e.tags || []).forEach(function(t) {
                tags[t] = (tags[t] || 0) + 1;
            });
        });
        return tags;
    }

    function renderTagCloud() {
        var tags = getAllTags();
        var sorted = Object.keys(tags).sort(function(a,b) { return tags[b] - tags[a]; });
        tagCloud.innerHTML = '';
        sorted.slice(0, 20).forEach(function(tag) {
            var span = document.createElement('span');
            span.className = 'tag' + (tag === activeTag ? ' active' : '');
            span.textContent = tag + ' (' + tags[tag] + ')';
            span.onclick = function() {
                activeTag = activeTag === tag ? null : tag;
                render();
            };
            tagCloud.appendChild(span);
        });
    }

    function getFilteredEntries() {
        var search = filterText.value.toLowerCase();
        return entries.filter(function(e) {
            if (activeTag && (e.tags || []).indexOf(activeTag) === -1) return false;
            if (search && e.text.toLowerCase().indexOf(search) === -1) return false;
            return true;
        });
    }

    function formatDate(ts) {
        var d = new Date(ts);
        return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    function renderEntries() {
        var filtered = getFilteredEntries();
        entryCount.textContent = filtered.length + ' observation' + (filtered.length !== 1 ? 's' : '');
        activeFilter.textContent = activeTag ? '[tag: ' + activeTag + ']' : '';

        if (filtered.length === 0) {
            entriesList.innerHTML = '<div class="empty">No observations yet. Start noticing.</div>';
            return;
        }

        entriesList.innerHTML = '';
        filtered.sort(function(a,b) { return b.ts - a.ts; }).forEach(function(e, i) {
            var div = document.createElement('div');
            div.className = 'entry';

            var tagsHtml = (e.tags || []).map(function(t) {
                return '<span class="entry-tag">' + escapeHtml(t) + '</span>';
            }).join('');

            div.innerHTML =
                '<div class="entry-meta">' +
                    '<span>' + formatDate(e.ts) + '</span>' +
                    '<div class="entry-tags">' + tagsHtml + '</div>' +
                '</div>' +
                '<div class="entry-text">' + escapeHtml(e.text) + '</div>' +
                '<div class="entry-actions">' +
                    '<button onclick="deleteEntry(' + e.ts + ')">Delete</button>' +
                '</div>';

            entriesList.appendChild(div);
        });
    }

    function renderStats() {
        var tags = getAllTags();
        var tagCount = Object.keys(tags).length;
        stats.textContent = entries.length + ' total observations · ' + tagCount + ' unique tags';
    }

    function render() {
        renderTagCloud();
        renderEntries();
        renderStats();
    }

    function escapeHtml(str) {
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    window.addEntry = function() {
        var text = obsText.value.trim();
        if (!text) return;

        var tags = obsTags.value.split(',')
            .map(function(t) { return t.trim().toLowerCase(); })
            .filter(function(t) { return t; });

        entries.push({
            ts: Date.now(),
            text: text,
            tags: tags
        });

        save();
        obsText.value = '';
        obsTags.value = '';
        render();
        obsText.focus();
    };

    window.deleteEntry = function(ts) {
        if (!confirm('Delete this observation?')) return;
        entries = entries.filter(function(e) { return e.ts !== ts; });
        save();
        render();
    };

    window.exportData = function() {
        var data = JSON.stringify(entries, null, 2);
        var blob = new Blob([data], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'din_observations_' + new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    window.importData = function() {
        importInput.click();
    };

    importInput.onchange = function() {
        var file = importInput.files[0];
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    var count = 0;
                    data.forEach(function(item) {
                        if (item.text && item.ts) {
                            entries.push(item);
                            count++;
                        }
                    });
                    save();
                    render();
                    alert('Imported ' + count + ' observations');
                }
            } catch(err) {
                alert('Invalid JSON file');
            }
        };
        reader.readAsText(file);
        importInput.value = '';
    };

    filterText.oninput = render;

    obsText.onkeydown = function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            addEntry();
        }
    };

    load();
    render();
})();
</script>

</body>
</html>
