<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODEX Compress - Archival Prep</title>
    <style>
        :root {
            --bg: #0a0a0c;
            --surface: #111115;
            --border: #252530;
            --text: #d0d0d8;
            --text-dim: #6a6a78;
            --accent: #00aaff;
            --accent-dim: #0088cc;
            --success: #00cc66;
            --warning: #ffaa00;
            --retro: #00ff88;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 16px;
        }
        .container { max-width: 700px; margin: 0 auto; }
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, #151520 0%, var(--surface) 100%);
        }
        h1 {
            font-size: 1.3rem;
            font-weight: normal;
            letter-spacing: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .disk-icon {
            font-size: 1.5rem;
            animation: spin 8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .subtitle {
            color: var(--retro);
            font-size: 0.7rem;
            margin-top: 6px;
            letter-spacing: 2px;
        }
        .tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
            margin-bottom: 16px;
            background: var(--border);
            padding: 2px;
        }
        .tab {
            padding: 10px 4px;
            background: var(--surface);
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 0.7rem;
            font-family: inherit;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .tab.active {
            background: var(--accent-dim);
            color: white;
        }
        .tab:hover:not(.active) { background: #1a1a22; }
        .panel { display: none; }
        .panel.active { display: block; }
        .form-group { margin-bottom: 12px; }
        label {
            display: block;
            margin-bottom: 4px;
            color: var(--text-dim);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        textarea, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            background: #08080a;
            border: 1px solid var(--border);
            color: var(--retro);
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
        }
        textarea { min-height: 100px; }
        textarea:focus, input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .btn-row {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover { background: #1a1a22; border-color: var(--accent); }
        .btn-primary {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: white;
        }
        .btn-primary:hover { background: var(--accent); }
        .output-box {
            background: #08080a;
            border: 1px solid var(--border);
            padding: 12px;
            margin-top: 12px;
        }
        .output-box h3 {
            color: var(--accent);
            font-size: 0.75rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 6px;
        }
        .output-box pre {
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.8rem;
            color: var(--retro);
            max-height: 200px;
            overflow-y: auto;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin: 12px 0;
        }
        .stat-box {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.4rem;
            color: var(--retro);
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }
        .floppy-rating {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
            text-align: center;
            margin-top: 12px;
        }
        .floppy-disks {
            font-size: 1.5rem;
            letter-spacing: 4px;
            margin: 8px 0;
        }
        .floppy-text {
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .file-list {
            background: #08080a;
            border: 1px solid var(--border);
            max-height: 200px;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
        }
        .file-item:last-child { border-bottom: none; }
        .file-name { color: var(--text); }
        .file-size { color: var(--accent); }
        .disk-allocation {
            margin-top: 12px;
        }
        .disk-group {
            background: var(--surface);
            border: 1px solid var(--border);
            margin-bottom: 8px;
            padding: 10px;
        }
        .disk-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }
        .disk-name { color: var(--accent); }
        .disk-usage { color: var(--warning); }
        .disk-bar {
            height: 8px;
            background: #1a1a22;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .disk-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            transition: width 0.3s;
        }
        .disk-files {
            font-size: 0.7rem;
            color: var(--text-dim);
        }
        .hidden { display: none; }
        footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 0.65rem;
            letter-spacing: 1px;
        }
        @media (max-width: 500px) {
            .tabs { grid-template-columns: repeat(2, 1fr); }
            .btn { flex: 1; min-width: 0; padding: 8px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="disk-icon">ðŸ’¾</span> CODEX COMPRESS</h1>
            <div class="subtitle">[ ARCHIVAL PREPARATION SYSTEM ]</div>
        </header>

        <div class="tabs">
            <button class="tab active" data-tab="text">TEXT</button>
            <button class="tab" data-tab="url">URL</button>
            <button class="tab" data-tab="manifest">MANIFEST</button>
            <button class="tab" data-tab="size">SIZE</button>
        </div>

        <!-- TEXT COMPRESS -->
        <div id="text" class="panel active">
            <div class="form-group">
                <label>Input Text / Markdown</label>
                <textarea id="textInput" placeholder="Paste text to compress..."></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="compressText()">Compress</button>
                <button class="btn" onclick="copyOutput('textOutput')">Copy</button>
                <button class="btn" onclick="clearText()">Clear</button>
            </div>
            <div id="textResult" class="hidden">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="textBefore">0</div>
                        <div class="stat-label">Before (bytes)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="textAfter">0</div>
                        <div class="stat-label">After (bytes)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="textSaved">0%</div>
                        <div class="stat-label">Saved</div>
                    </div>
                </div>
                <div class="floppy-rating">
                    <div class="floppy-text">FLOPPY GRADE</div>
                    <div class="floppy-disks" id="floppyDisks">ðŸ’¾</div>
                    <div class="floppy-text" id="floppyCopies">0 copies per 1.44MB disk</div>
                </div>
                <div class="output-box">
                    <h3>Compressed Output</h3>
                    <pre id="textOutput"></pre>
                </div>
            </div>
        </div>

        <!-- URL COMPRESS -->
        <div id="url" class="panel">
            <div class="form-group">
                <label>Paste HTML Source (Ctrl+U from page)</label>
                <textarea id="urlInput" placeholder="Paste HTML source code..."></textarea>
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="extractContent()">Extract</button>
                <button class="btn" onclick="copyOutput('urlOutput')">Copy</button>
                <button class="btn" onclick="clearUrl()">Clear</button>
            </div>
            <div id="urlResult" class="hidden">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="urlBefore">0</div>
                        <div class="stat-label">HTML (bytes)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="urlAfter">0</div>
                        <div class="stat-label">Text (bytes)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="urlRatio">0%</div>
                        <div class="stat-label">Extracted</div>
                    </div>
                </div>
                <div class="output-box">
                    <h3>Extracted Content</h3>
                    <pre id="urlOutput"></pre>
                </div>
            </div>
        </div>

        <!-- MANIFEST GENERATOR -->
        <div id="manifest" class="panel">
            <div class="form-group">
                <label>File List (name and size per line, or just paste output)</label>
                <textarea id="manifestInput" placeholder="file1.txt 1024&#10;file2.md 2048&#10;image.png 15360&#10;&#10;Or paste 'dir' or 'ls -la' output..."></textarea>
            </div>
            <div class="form-group">
                <label>Archive Name</label>
                <input type="text" id="archiveName" placeholder="CODEX_ARCHIVE_001" value="CODEX_ARCHIVE">
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="generateManifest()">Generate</button>
                <button class="btn" onclick="copyOutput('manifestOutput')">Copy</button>
                <button class="btn" onclick="downloadManifest()">Download</button>
            </div>
            <div id="manifestResult" class="hidden">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="manifestFiles">0</div>
                        <div class="stat-label">Files</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="manifestSize">0</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                </div>
                <div class="output-box">
                    <h3>manifest.txt</h3>
                    <pre id="manifestOutput"></pre>
                </div>
            </div>
        </div>

        <!-- SIZE CALCULATOR -->
        <div id="size" class="panel">
            <div class="form-group">
                <label>File List (name size per line)</label>
                <textarea id="sizeInput" placeholder="document.pdf 524288&#10;photos.zip 1048576&#10;backup.tar 2097152"></textarea>
            </div>
            <div class="form-group">
                <label>Disk Size (bytes) - Default: 1.44MB Floppy</label>
                <input type="number" id="diskSize" value="1474560" min="1024">
            </div>
            <div class="btn-row">
                <button class="btn btn-primary" onclick="calculateDistribution()">Calculate</button>
                <button class="btn" onclick="setDiskSize(1474560)">1.44MB</button>
                <button class="btn" onclick="setDiskSize(734003200)">CD 700MB</button>
                <button class="btn" onclick="setDiskSize(4700000000)">DVD 4.7GB</button>
            </div>
            <div id="sizeResult" class="hidden">
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="sizeTotal">0</div>
                        <div class="stat-label">Total Size</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="sizeDisks">0</div>
                        <div class="stat-label">Disks Needed</div>
                    </div>
                </div>
                <div class="disk-allocation" id="diskAllocation"></div>
            </div>
        </div>

        <footer>
            CODEX COMPRESS v1.0 â€¢ ARCHIVAL GRADE â€¢ FLOPPY COMPATIBLE
        </footer>
    </div>

<script>
const FLOPPY_SIZE = 1474560; // 1.44MB in bytes

// ============================================================
// TAB NAVIGATION
// ============================================================
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

// ============================================================
// TEXT COMPRESS
// ============================================================
function compressText() {
    const input = document.getElementById('textInput').value;
    if (!input) { alert('Please enter text'); return; }

    const before = new Blob([input]).size;

    // Compression steps
    let compressed = input
        // Normalize line endings
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        // Remove trailing whitespace
        .replace(/[ \t]+$/gm, '')
        // Collapse multiple blank lines to max 2
        .replace(/\n{3,}/g, '\n\n')
        // Collapse multiple spaces to single
        .replace(/[ \t]+/g, ' ')
        // Remove spaces at start of lines (except in code blocks)
        .replace(/^[ \t]+(?![`*-])/gm, '')
        // Trim
        .trim();

    const after = new Blob([compressed]).size;
    const saved = before > 0 ? Math.round((1 - after / before) * 100) : 0;
    const copies = Math.floor(FLOPPY_SIZE / after);

    document.getElementById('textBefore').textContent = before.toLocaleString();
    document.getElementById('textAfter').textContent = after.toLocaleString();
    document.getElementById('textSaved').textContent = saved + '%';
    document.getElementById('textOutput').textContent = compressed;

    // Floppy rating
    const floppyCount = Math.min(copies, 10);
    document.getElementById('floppyDisks').textContent = 'ðŸ’¾'.repeat(floppyCount) + (copies > 10 ? '+' : '');
    document.getElementById('floppyCopies').textContent = copies.toLocaleString() + ' copies per 1.44MB disk';

    document.getElementById('textResult').classList.remove('hidden');
}

function clearText() {
    document.getElementById('textInput').value = '';
    document.getElementById('textResult').classList.add('hidden');
}

// ============================================================
// URL/HTML COMPRESS
// ============================================================
function extractContent() {
    const html = document.getElementById('urlInput').value;
    if (!html) { alert('Please paste HTML source'); return; }

    const before = new Blob([html]).size;

    // Create DOM parser
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Remove unwanted elements
    const removeSelectors = [
        'script', 'style', 'noscript', 'iframe', 'svg', 'canvas',
        'nav', 'header', 'footer', 'aside', 'form', 'button',
        '[role="navigation"]', '[role="banner"]', '[role="contentinfo"]',
        '.nav', '.navigation', '.menu', '.sidebar', '.footer', '.header',
        '.ads', '.advertisement', '.social', '.share', '.comments',
        '#nav', '#menu', '#sidebar', '#footer', '#header', '#comments'
    ];

    removeSelectors.forEach(sel => {
        doc.querySelectorAll(sel).forEach(el => el.remove());
    });

    // Get main content (try common content selectors)
    const contentSelectors = ['main', 'article', '[role="main"]', '.content', '.post', '#content', '.article'];
    let content = null;

    for (const sel of contentSelectors) {
        content = doc.querySelector(sel);
        if (content) break;
    }

    // Fallback to body
    if (!content) content = doc.body;

    // Extract text
    let text = content ? content.textContent : '';

    // Clean up
    text = text
        .replace(/\s+/g, ' ')           // Collapse whitespace
        .replace(/\n\s*\n/g, '\n\n')    // Normalize paragraphs
        .replace(/^\s+|\s+$/gm, '')     // Trim lines
        .trim();

    // Split into paragraphs
    const paragraphs = text.split(/\s{2,}/).filter(p => p.length > 20);
    text = paragraphs.join('\n\n');

    const after = new Blob([text]).size;
    const ratio = before > 0 ? Math.round((after / before) * 100) : 0;

    document.getElementById('urlBefore').textContent = formatBytes(before);
    document.getElementById('urlAfter').textContent = formatBytes(after);
    document.getElementById('urlRatio').textContent = ratio + '%';
    document.getElementById('urlOutput').textContent = text || '(No content extracted)';

    document.getElementById('urlResult').classList.remove('hidden');
}

function clearUrl() {
    document.getElementById('urlInput').value = '';
    document.getElementById('urlResult').classList.add('hidden');
}

// ============================================================
// MANIFEST GENERATOR
// ============================================================
function generateManifest() {
    const input = document.getElementById('manifestInput').value;
    const archiveName = document.getElementById('archiveName').value || 'ARCHIVE';

    if (!input) { alert('Please enter file list'); return; }

    // Parse file list
    const files = [];
    const lines = input.split('\n');

    for (const line of lines) {
        // Try to parse various formats
        let match;

        // Format: filename size
        match = line.match(/^(.+?)\s+(\d+)\s*$/);
        if (match) {
            files.push({ name: match[1].trim(), size: parseInt(match[2]) });
            continue;
        }

        // Format: ls -la style
        match = line.match(/^\S+\s+\d+\s+\S+\s+\S+\s+(\d+)\s+\S+\s+\d+\s+[\d:]+\s+(.+)$/);
        if (match) {
            files.push({ name: match[2].trim(), size: parseInt(match[1]) });
            continue;
        }

        // Format: dir style (size first, then name)
        match = line.match(/(\d{1,3}(?:,\d{3})*)\s+(.+)$/);
        if (match) {
            files.push({ name: match[2].trim(), size: parseInt(match[1].replace(/,/g, '')) });
            continue;
        }

        // Just filename (assume 0 size)
        const trimmed = line.trim();
        if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('total')) {
            files.push({ name: trimmed, size: 0 });
        }
    }

    if (files.length === 0) {
        alert('Could not parse any files from input');
        return;
    }

    // Calculate hashes (simple)
    const totalSize = files.reduce((sum, f) => sum + f.size, 0);

    // Generate manifest
    const now = new Date().toISOString().slice(0, 19).replace('T', ' ');
    let manifest = `================================================================================
${archiveName}
MANIFEST.TXT
================================================================================
Generated: ${now}
Files: ${files.length}
Total Size: ${formatBytes(totalSize)} (${totalSize.toLocaleString()} bytes)
================================================================================

FILE LISTING
--------------------------------------------------------------------------------
`;

    files.forEach((f, i) => {
        const hash = simpleHash(f.name + f.size).slice(0, 8);
        manifest += `${String(i + 1).padStart(3, '0')}  ${hash}  ${String(f.size).padStart(12, ' ')}  ${f.name}\n`;
    });

    manifest += `
--------------------------------------------------------------------------------
CHECKSUM: ${simpleHash(manifest).toUpperCase()}
================================================================================
`;

    document.getElementById('manifestFiles').textContent = files.length;
    document.getElementById('manifestSize').textContent = formatBytes(totalSize);
    document.getElementById('manifestOutput').textContent = manifest;
    document.getElementById('manifestResult').classList.remove('hidden');
}

function downloadManifest() {
    const content = document.getElementById('manifestOutput').textContent;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'manifest.txt';
    a.click();
    URL.revokeObjectURL(url);
}

// ============================================================
// SIZE CALCULATOR
// ============================================================
function setDiskSize(size) {
    document.getElementById('diskSize').value = size;
}

function calculateDistribution() {
    const input = document.getElementById('sizeInput').value;
    const diskSize = parseInt(document.getElementById('diskSize').value) || FLOPPY_SIZE;

    if (!input) { alert('Please enter file list'); return; }

    // Parse files
    const files = [];
    input.split('\n').forEach(line => {
        const match = line.match(/^(.+?)\s+(\d+)\s*$/);
        if (match) {
            files.push({ name: match[1].trim(), size: parseInt(match[2]) });
        }
    });

    if (files.length === 0) {
        alert('Could not parse files. Use format: filename size');
        return;
    }

    // Sort by size descending (first-fit decreasing)
    files.sort((a, b) => b.size - a.size);

    // Allocate to disks
    const disks = [];

    for (const file of files) {
        if (file.size > diskSize) {
            // File too big for single disk
            disks.push({
                files: [file],
                used: file.size,
                oversized: true
            });
            continue;
        }

        // Find first disk with space
        let placed = false;
        for (const disk of disks) {
            if (!disk.oversized && disk.used + file.size <= diskSize) {
                disk.files.push(file);
                disk.used += file.size;
                placed = true;
                break;
            }
        }

        if (!placed) {
            disks.push({
                files: [file],
                used: file.size,
                oversized: false
            });
        }
    }

    // Calculate total
    const totalSize = files.reduce((sum, f) => sum + f.size, 0);

    document.getElementById('sizeTotal').textContent = formatBytes(totalSize);
    document.getElementById('sizeDisks').textContent = disks.length;

    // Render disk allocation
    const allocationEl = document.getElementById('diskAllocation');
    allocationEl.innerHTML = disks.map((disk, i) => {
        const pct = Math.min(100, (disk.used / diskSize) * 100);
        const color = disk.oversized ? 'var(--warning)' : 'var(--success)';
        return `
            <div class="disk-group">
                <div class="disk-header">
                    <span class="disk-name">ðŸ’¾ DISK ${String(i + 1).padStart(2, '0')}</span>
                    <span class="disk-usage" style="color:${color}">${formatBytes(disk.used)} / ${formatBytes(diskSize)} (${pct.toFixed(1)}%)</span>
                </div>
                <div class="disk-bar">
                    <div class="disk-fill" style="width:${pct}%;background:${color}"></div>
                </div>
                <div class="disk-files">${disk.files.map(f => f.name).join(', ')}</div>
            </div>
        `;
    }).join('');

    document.getElementById('sizeResult').classList.remove('hidden');
}

// ============================================================
// UTILITIES
// ============================================================
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function simpleHash(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return Math.abs(hash).toString(16).padStart(8, '0');
}

function copyOutput(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text);
    alert('Copied to clipboard');
}
</script>
</body>
</html>
